# IO模型

## 同步、异步、阻塞、非阻塞

同步、异步关注消息通信机制（打电话咨询书籍，是否立即挂电话）

- 同步：调用发出后，只有当生产了结果，才会调用返回，调用者主动等待调用的返回。

- 异步：调用发出后，调用立即返回，因此没有返回结果，被调用者通过状态、通知来通知调用者，或回调函数处理调用。

阻塞、非阻塞关注的是调用者在等待调用结果时的状态。(打电话咨询书籍，是否一直守着电话)

- 阻塞：等待结果时，阻塞调用线程。
- 非阻塞：等待结果时，不会阻塞调用线程。

### 操作系统层次

操作系统处理IO时通常采用异步非阻塞进行IO(少部分IO采用同步非阻塞轮询)，即发出IO请求后并不等待IO操作完成(异步)，继续执行其他指令(非阻塞)，IO操作与 CPU指令互不干扰，最后通过中断来通知IO操作完成。

### 线程层次

操作系统在调度单元层次中，为减轻程序员的思考负担，将异步非阻塞的IO方式进行封装，将相关系统调用以同步的形式(read、write)展现出来，这样同步阻塞IO会使线程挂起，同步非阻塞IO会消耗CPU资源用于轮询。解决方案

- 多线程：同步阻塞IO
- IO多路复用(select,poll,epoll)：同步非阻塞
- 直接暴露异步IO接口，kernel-aio和IOCP(windows实现的aio解决方案)：异步非阻塞

### 业务层次

库和框架是对IO多路复用进行封装，以同步、异步的形式展现出来。

# 新概念

- 进程间的通信是通过`send`和`receive`两种基本操作。
- 阻塞发送：发送进程一直阻塞，直到消息被接收进程接收。
- 非阻塞发送：发送进程调用`send`后，可以执行其他操作。
- 阻塞接收：接收进程一直阻塞，直到有消息可用。
- 非阻塞接收：接收方调用`receive`后，要么是可用消息，要么是空值，不会阻塞。
- 进程同学维度，阻塞与同步是同义词。

## 用户空间和内核空间

操作系统为了支持多个应用同时运行，需要保证不同的进程之间相互独立，因此操作系统内核需要拥有更高的权限用于调度与管理用户的进程程序。

内存空间被分割为了两部分：内核空间与用户空间，内核空间中存储的代码与数据比用户空间中的权限高。内存访问的相关硬件会在程序执行过程中，进行访问控制，使之不能直接读写内核空间的内存。

## 进程切换

当进程A运行时，中断或系统调用会使得CPU的控制权从进程A交由操作系统内核。内核会保存进程A的上下文，然后加载处理中断或系统调用的进程B的上下文，将CPU的控制权交由进程B。

底层概念：

- 中断：CPU中有一个中断信号位，在每个时钟周期末尾，CPU通过中断信号位来判断是否有中断信号到达，若有，则根据中断优先级判断是否需要暂停当前的执行的指令，去执行处理中断的指令。(CPU层while 轮询)
- 时钟中断：硬件时钟会隔一定周期，发送中断信号给CPU，CPU响应中断时，需要执行操作系统指令，从而将CPU控制权交给了内核。
- 系统调用：操作系统提供给应用程序的接口，用户通过系统调用来完成有内核控制的操作，如硬盘、网络设备读写。
- 进程切换需要一系列内存读写操作，会有一定开销，运行Unix系统的现代PC，进程切换至少消耗300us。

## 进程阻塞

进程五状态：

- New：创建进程
- Running：进程的指令正在被执行
- Waiting：等待某些事件发生，如IO
- Ready：等待操作调用。
- Terminated：进程执行完毕。

阻塞：进程发起系统调用后，由于系统调用需要耗时，所以该进程进入等待状态，不会占用CPU资源(一个CPU任意时刻只能执行一个进程)，所以阻塞、非阻塞描述的是进程的某个操作是否会让其进入等待状态。

进程进入等待状态只有两种方法：自己主动调用wait或sleep或进行系统调用，系统调用涉及到了IO操作，不能立即完成，因此内核会将其设置为等待状态，当IO操作完成后，再将其设置为ready状态。

处理系统调用时，CPU需要与IO设备进行交互，这里就涉及了阻塞与非阻塞问题，CPU可以阻塞式等待IO设备返回结果，也可以非阻塞式的继续执行其他操作，这些物理通信操作基本是异步执行的，即发出请求后，等待IO设备中断信号，再读取相应的设备缓冲区。

大部分操作系统会默认为用户进程提供阻塞式系统调用，这样代码执行的顺序与编写顺序相同。

操作系统也提供非阻塞IO系统调用接口，不会挂起程序，而是返回一个值，表示多少bytes数据被成功读取或写入。

异步IO系统调用接口会让系统调用立即返回，不会等到IO完成，当IO操作完成后，操作系统通过信号、软终端、调用进程回调函数)来通知相应进程。

非阻塞式IO系统调用的read方法可能读取到完整数据、不完整数据、空值，而异步式IO系统调用读取的一定是完整的。

## 



## 书籍

- 《分布式系统：概念与设计》
- 《操作系统概念》
- 《微机原理》 DPL，CPL
