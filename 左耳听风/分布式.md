# 分布式

## 什么是分布式架构？

- 采用分布式架构的目的？

  采用分布式主要有两个目的：通过增加节点增大系统业务容量、通过冗余系统提高系统可用性、并行开发和服务解耦

- 分布式架构的问题？

  架构设计复杂，学习曲线高、部署多个服务，流程复杂、运维复杂度随服务增加而增加、测试和查错的复杂度增加、管理分布式系统中的服务和调度变得困难和复杂

- 分布式难点是什么？

  CAP

- Martin Folwer 文章：https://martinfowler.com › articles › microservices

## 亚马逊分布式实践

亚马逊的架构规定：

- 团队间程序模块的通信只能采用接口的形式。
- 所有的Service Interface必须设计成能对外开放。

分布式带来的问题：

- 线上故障的工单会在不同服务和团队之间转来转去：通过每个服务都要提供人准备修复工单，每次出现工单，都上线准备解决问题。
- 每个团队都可能成为一个潜在的DDoS攻击者，除非每个服务都要做好配额和限流。
- 监控和查错变得更为复杂。
- 服务发现和服务之力变得复杂。

亚马逊的实践：

- 分布式服务的架构需要分布式的团队架构：将团队拆分为小团队，按职责分工，而不是按技能。
- 分布式服务查错不容易：出现故障后，每个相关的团队都会上线，签到自查，然后等待问题解决。
- 开发完成所有的任务，包括测试，运维，好处是吃自己的狗粮，让自己明白写代码容易维护代码复杂，这样开发人员会在需求、设计等方面考虑软件的长期维护性。
- 运维优先，崇尚简化和自动化。
- 内部服务和外部服务一致，让内部服务随时都可以开放出来。

分布式系统中需要注意的问题：

**异构系统的不标准问题：**因为不同的软件、不同的语言带来了不同的开发运维标准。不同的标准带来导致架构复杂度提升。

- 接口必须采用Swagger规范。
- 配置管理应该分为三层：
  - 底层：和操作系统有关
  - 中间层：和中间件有关
  - 业务层：和业务相关
  - 只有业务层允许用户灵活修改，底层和中间层提供模板让用户选择。
- 数据通信协议，必须有协议头和协议体，协议体是业务数据，协议头定义基本的协议数据。

**系统架构中的服务依赖性：**服务是由依赖的，一个服务依赖的某个服务挂了后，会出现多米诺骨牌效应。一个非关键业务被关键业务所依赖，会导致非关键业务变成关键业务。

核心问题是定义出服务的关键程度的同时，还需要我们定义或描述出关键业务或服务调用的主要路径。这里需要注意的是：不仅仅要业务隔离，还有数据库隔离，防止非关键业务将数据库拖死，导致整个业务不可用。微服务的要求是：服务之间只通过接口耦合，不仅仅要拆分服务，还有为每个服务拆分相应的数据库。

**故障发生的概率更大：**分布式系统中，使用的机器和服务更多，导致故障发生的频率更大；管理负责，导致很少有人知道架构中有什么(路径图)。这要求我们在设计或运维系统时，必须为故障所考虑，SLA的关键指标，设计时要考虑如何减轻故障，如果无法减轻故障，必须采用自动化的方式恢复故障，减少故障影响面，通过机器自动化帮忙我们，因为我们无法对复杂的事情做到事无巨细。

**多层架构的运维复杂度更大：**系统分层四层：基础层、平台层、应用层、接入层

- 基础层：机器、网络设备等
- 平台层：中间件，如Tomcat、MySQL、Kafka
- 应用层：业务软件
- 接入层：接入用户请求的网关、负载均衡、CDN等

任何一层的问题都会导致整体的问题。如果没有统一的视图和管理，导致运维被割裂开，造成更大的复杂度。分工不是问题，如何确保分后后的协作统一和规范才是核心。
