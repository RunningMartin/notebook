# 魔法数0x5f3759df

平方根倒数速算法：
$$
y=\frac{1}{x^2}
$$
其源码为：

```c
float Q_rsqrt(float number){
    long i;
    float x2,y;
    const float threehalfs=1.5F;
 	
    x2=number*0.5F;
    y=number;
 	// 将y转换为整形
    i=*(long *)&y;
    i=0x5f3759df - (i>>1);
    // 将结果转换为浮点型
    y=*(float *)&i;
    //通过牛顿迭代法计算结果
    y=y*（threehalfs -(x2*y*y)）;
    return y;
}
```

- 疑点1：魔法数0x5f3759df出现的原因

在C语言中，32位的浮点数采用IEEE 754表示：符号位1bit(S)，指数位8bits(E)，尾数位23bits(M)。一个浮点数的计算方法为：
$$
(-1)^S*(1+\frac{M}{2^{23}})*2^{(E-127)}
$$
其中M和E为尾数位和指数位的整数表示方法。

举例：3.14

符号位：S=0

指数位：2^1<3.14<2^2，所以指数n=1，但是为了表示0到1的小数，E=1+127。

尾数位：0.57*2^23≈4781507。
$$
\frac{3.14-2^n}{2^n-2^{n-1}}=0.57
$$
浮点数转换为整数：E*2^{23}+M，因为平方根倒数>0。

平方根倒数公式推导：
$$
y=x^{-\frac{1}{2}} \\
log_2(y)=-\frac{1}{2}log_2(x)\\
log_2((1+\frac{M_y}{2^{23}})*2^{E_y-127})=-\frac{1}{2}log_2((1+\frac{M_x}{2^{23}})*2^{E_x-127})\\
因为1+\frac{M_y}{2^{23}}在1到2之间时,log(1+\frac{M_y}{2^{23}})\approx \frac{M_y}{2^{23}}+\omicron \\
M_y+\omicron +2^{23}*(E_y-127)=-\frac{1}{2}*(M_x+\omicron -2^{23}*(E_x-127))\\
M_y+2^{23}*E_y=-\frac{1}{2}*(M_x+2^{23}*E_x)-\frac{3}{2}*2^{23}*(\omicron-127)\\
因为浮点数的整形为E*2^{23}+M，令I=E*2^{23}+M\\
R=-\frac{3}{2}*2^{23}*(\omicron-127)\\
I_y=R-\frac{1}{2}*I_x\\
转换为代码及：0x5f3759df - (i>>1);\\
R=0x5f3759df\\
$$

- 牛顿迭代法。

牛顿迭代法是一种通过逼近的方式计算f(x)=0的方式，其通项公式为：
$$
x_{n+1}=x_n-\frac{f(x_n)}{f`(x_n)} \\
对于y=x^{-\frac{1}{2}}，求y使y-x=0\\
带入后\\
y_{n+1}=\frac{y_n(3-xy_n^2)}{2}=y_n*(1.5-0.5xy_n^2)
$$
