# HTTP协议学习笔记(九)—HTTP2

## 0X00 梗概

HTTP/1有两个主要的缺点：

- 安全方面
- 性能方面

HTTPS协议通过引入`SSL/TLS`协议解决了安全方面的问题。但性能方面只优化了握手流程，传输过程中没有优化，HTTP/2主要优化传输过程。HTTP/2也基于TCP协议，其协议栈为：

![HTTP/2协议栈,图片来源于极客时间](raws/HTTP2/HTTP2 协议栈.png)

HTTP/2有如下特点：

- 兼容HTTP/1
- 压缩头部：通过HPACK算法压缩头部
- 二进制帧传输：将报文碎片化为二进制帧，采用帧来传输数据
- 多路复用：通过流实现了多路复用

## 0X01 兼容HTTP/1

HTTP/2为了保持和HTTP/1的兼容性，将HTTP协议拆分为了语法和语义两部分。语义部分和HTTP/1完全相同，因此HTTP上层应用可以在不做任何修改的基础上，无缝切换到HTTP/2。HTTP/2和HTTP/1使用相同的协议名：https和http，由服务器或客户端自行决定采用哪个协议。

语义部分，HTTP/2主要做了两点修改：

- 存储形式：HTTP/2采用二进制的形式存储报文(原本是ASCII码)，提高了处理效率。
- 传输方式：HTTP/2将报文拆分为帧，以帧的形式传输给对端。

由于主流的浏览器只支持加密版本的HTTP/2，因此日常只能使用加密传输的HTTP/2。但HTTP/2也支持非加密，HTTP/2定义了两个标识符：`h2`(加密)、`h2c`(明文)。非加密版的HTTP/2常用于内网传输。

## 0X02 连接

客户端与服务器完成握手后，向服务器发送Magic(`PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n`)。服务器识别到该字符串后，后续数据将采用HTTP/2。

![HTTP2 连接](raws/HTTP2/HTTP2 连接.png)

## 0X03 头部压缩

HTTP/2采用HPACK算法压缩报文头部，其核心是在客户端和服务器上各自维护一个头部信息表(键值对)。这个表和连接相关联，如果连接断开，将重新维护。

![HTTP 2静态表,图片来源于极客时间](raws/HTTP2/HTTP 2静态表.png)

客户端发送请求时，执行压缩操作：如果键值对已经存在，则转换为相应序号；如果不存在，则使用原文。压缩后，头部将由已存键值对的序号和未存键值对原文组成。压缩时还采用哈夫曼编码对字符串进一步压缩。

服务器收到请求后，执行解压缩操作：针对序号，查表获取原文；针对原文，更新表。生成响应，向客户端发送响应。客户端收到响应后，更新表中装备状态的键值对。

为了方便管理和压缩，HTTP/2使用伪头部字段替换了HTTP/1协议中的起始行，将整个头部都整合为KV结构。伪头部字段以`:`开头，如`:authority`(域名)、`:method`(方法)、`:status`(状态码)。

头部信息表又分为静态表和动态表：

- 静态表存储常用的头部信息

![HTTP 2静态表,图片来源于极客时间](raws/HTTP2/HTTP 2静态表.png)

- 动态表存储两端动态变化的头部信息

随着报文数量的增加，头部信息表将越来越丰富，报文的头部也将越来越小，直到全部采用序号表示。

## 0X04 二进制帧

HTTP/2的帧结构简单，其头部只有9个字节。

![HTTP 2帧结构,图片来源于极客时间](raws/HTTP2/HTTP2 帧结构.png)

- 帧长度为3个字节，描述数据部分长度，默认上限为`2^14=16k`，最大上限为`2^24=16M`。
- 帧类型为1个字节，共两大类：数据帧(DATA、HEADERS)和控制帧(SETTINGS、PING、PRIORITY等管理流的控制帧)。
- 标志位为1个字节，常用标志位：END_HEADERS(\r\n)头数据结束、END_STREAM(0\r\n\r\n)单向数据发送结束。
- 流标识符为4个字节(31位)，标识这个帧所属流ID。

![HTTP2 帧](raws/HTTP2/HTTP2 帧.png)

## 0X05 流与多路复用

流是二进制帧的双向传输序列，通过流ID来标识所属流。通过在同一连接上传输不同流的帧，可以实现多路复用。连接上的帧是乱序发送的，但在流中，帧是有序的。

![HTTP2 多路复用](raws/HTTP2/HTTP2 多路复用.png)

同一个流中，客户端和服务器都可以发送、接收数据。同一个连接中，流的ID不能复用，只能递增。客户端和服务器都可以创建流，客户端发起的流ID是奇数，服务器发起的流ID是偶数。不同的流可以通过设置优先级，让对端优先处理。流中有一个特殊流：0号，这个流只能发送控制帧，用于流量控制。客户端最多在一个连接里发起`2^30`个流(请求)，当ID用完后，发送控制帧`GOAWAY`，关闭连接。

多路复用的好处有很多，举个简单的例子：取消文件下载时，只需要在流上发送`RST_STREAM`帧即可中断流，而不断开连接。

## 0X06 流状态转换

客户端发送`HEADERS`帧，获得流ID后，流进入了OPEN阶段两端都可以收发数据，客户端发送完数据后，发送`END_STREAM`帧，表示请求发送完毕，等待响应数据，流进入半关闭状态。服务器发送完响应数据后，发送`END_STEAM`帧，流进入关闭状态。

![HTTP2 请求与响应状态切换,图片来源于极客时间](raws/HTTP2/HTTP2 请求与响应状态切换.png)

服务器可以通过发送`PUSH_PROMISE`帧，主动与客户端建立连接。

## 0X07 服务发现

针对加密版本的HTTP/2，客户端需要`Client Hello`的`ALPN`中添加支持的协议，由服务器选择，服务器也通过`ALPN`告知客户端后续通信采用的协议。

![HTTP2 ALPN](raws/HTTP2/HTTP2 ALPN.png)

非加密版本的HTTP/1中，客户端建立TCP连接后，将发送Magic。服务器识别到后，后续通信采用HTTP/2。

![Magic](raws/HTTP2/Magic.png)

## 0X08 总结

HTTP/2主要的优点是：兼容、安全、传输速度快。

在兼容方面，HTTP/2和HTTP/1完全兼容，拥有了HTTP/1简单易扩展等特点。

在安全方面，HTTP/2要求TLS必须是1.2+，而且只能使用ECDHE(前向安全)，同时默认采用`False Start`，支持`1-RTT`握手。

在传输方面，HTTP/2采用压缩搭配多路复用，避免了HTTP/1中队头阻塞的问题，能更好的利用带宽。HTTP/2中，服务器主动推送功能能直接将数据发送给客户端，节约了客户端主动请求的时间。

HTTP/2虽然拥有很多优点，但是也有很多缺点，比如：

- HTTP/2基于TCP协议，在TCP协议层次上存在队头阻塞问题。
- 移动网络中发送IP地址切换时，需要重新建立连接，HPACK字典将重新计算，浪费带宽。
- 同一个网站只能建立一个连接，当连接出现问题时，整个网站体验变差。HTTP/1可以采用建立多个连接和域名分片(多个域名指向同一主机，用于突破域名并发连接数)来解决。

HTTP/2中不要使用精灵图、资源内联、域名分片这些HTTP/1的优化手段。

- HTTP/2适用于小颗粒化的资源，精灵图是将多个小图合并为一个大文件，大文件传输会降低客户端的处理，并且当少量数据更新时，需要重新下载整个精灵图，缓存失效成本高。
- 内联资源是为了减少请求次数，HTTP/2将无法单独缓存内联资源，无法使用多路复用来加速。
- 域名分片会让客户端和多个域名建立连接，突破客户端对单域名连接数的限制，但建立多个连接，无法共用HPACK字典，增加HTTP/2的成功。

## 0X08 参考

- HPACK：https://http2.github.io/http2-spec/compression.html
- HTTP/2特性概览：https://time.geekbang.org/column/article/112036
- HTTP/2内核剖析：https://time.geekbang.org/column/article/113481