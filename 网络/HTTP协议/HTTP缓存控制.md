# HTTP缓存控制

HTTP传输过程中，一共有三个角色：

- 客户端
- 代理服务：面向客户端，表现为服务端；面向服务端，表现为客户端。
- 服务端

基于“请求-应答”模式的特点，三个角色都存在缓存。

## 服务端缓存控制策略

### 为什么要控制资源的有效期？

服务端的资源可能实时变化，不能保证过段时间，资源未变化，因此为了避免客户端的资源老旧，需要控制资源的有效期。

### 服务端如何控制资源的有效期

服务端通过响应的`Cache-Control`字段来控制资源的有效期。`Cache-Control`的值`max-age=30`，则表示该资源只能缓存30秒，起始时间是响应创建的时间。此外，`Cache-Control`还支持几个扩展属性用于精确控制客户端缓存。

- `no-store`：不允许缓存。
- `must-revalidate`：未过期可以直接使用；过期后必须去服务端验证。
- `no-cache`：可以缓存，但使用前必须去服务端验证，等价于`max-age=0;must-revalidate`。

![Cache-Control流程]()

如果响应没有`Cache-Control`字段，客户端会使用启发算法计算缓存时间，推荐为`(Date-Last-Modified)*10%`。

## 客户端缓存控制策略

客户端的缓存控制也是通过`Cache-Control`字段实现的，只是其添加了几个辅助字段便于验证资源是否最新。

客户端在刷新时会采用`Cache-Control:max-age=0`，来请求最新的资源；强制刷新时，通过`Cache-Control:no-cache`来请求最新资源。如果使用前进、后退，客户端不使用`Cache-Control`字段，所以会检查缓存，这时有效资源会从磁盘加载(`from disk cache`)。

### 条件请求

客户端只能使用`Cache-Control`来刷新资源，缓存失效后还必须去服务端验证资源是否为最新版。

客户端可以通过HEAD请求获取资源的修改时间等元数据，然后判断是否需要使用GET请求更新资源。这种操作在更新资源时会发送两次请求，成本较高。HTTP协议提供了5个条件请求字段用于验证资源是否过期，验证操作有服务端执行。当执行条件请求判断时，如果资源未改变，则会返回`304 Not Modified`。

常用的条件请求字段为`If-Modified-Since`和`If-None-Match`：

- `If-Modified-Since:time_a`：如果资源在`time_a`之后有修改，返回最新资源。在第一次请求资源时，响应中`Last-Modified`字段表示资源最近一次修改时间，时间格式为`RFC1123`。
- `If-None-Match:EtagA`：如果资源的`ETag`不为`EtagA`，返回最新资源。第一次请求资源时，响应中的`ETag`字段为资源的唯一标识，当资源更新，标识也会更新。

采用`Last-Modified`标记资源是否更新，存在两个个缺陷：

- `Last-Modified`对时间的敏感度为秒，如果资源在一秒内多次更新，则无法区分新版本。
- 资源定期更新，有时可能只改变了时间，这时更新资源会浪费带宽。

针对`Last-Modified`的缺陷，通常都是使用`ETag`。

`ETag`分为两种：强`ETag`（字节级别相同）和弱`ETag`（只要语义未改变，如删除空格，则不变，用`W/`前缀区分）

不常用的条件请求字段为`If-Match`、`If-Unmodified-Since`和`If-Range`。

- `If-Match:EtagA`：只有当EtagA的值与资源的Etag向匹配才会执行请求，否则返回`412 Precondition Failed`响应。ETagA值为`*`时，忽视`ETag`值。
- `If-Unmodified-Since:TimeA`：当资源在`TimeA`之后没有更新，服务器才处理请求，否则返回`412 Precondition Failed`响应。
- `If-Range:EtagA或TimeA`：如果资源的`Etag`值等于`EtagA`或时间等于`TimeA`，则处理该范围请求，否则返回整个资源，与`Range`联用。

## 代理缓存控制策略

### 代理服务

代理服务指服务本身不生产内容，而是出于中间位置转发上下游的请求和响应，其具备双重身份：

- 面向下游用户，表现为服务器，代表源服务器响应客户端的请求。
- 面向上游源服务器，表现为客户端，代表客户端发送请求。

代理常被分为四种：匿名代理、透明代理、正向代理和反向代理。反向代理是最常见的，其为源服务器提供代理服务。

### 代理的作用

- 负载均衡：客户端只能看到代理服务器，而看不到背后的源服务器数量及IP信息，因此可以利用代理服务器来分发请求，决定由哪个服务器来响应请求。

  ![负载均衡]()

- 健康检查：利用”心跳“等机制监控后端服务器，发现有故障可即使踢出集群，保证服务高可用。

- 安全防护：限制IP或流量，为后端服务器提供抵御网络攻击和过载的功能。

- 加密卸载：对外网采用SSL/TLS加密，对安全的内容不加密，消除加密成本。

- 数据过滤：拦截上下行数据，指定策略修改请求或响应。

- 内容缓存：暂存、复用服务器响应，降低服务器负荷。

### 代理相关字段

- `Via`：记录代理信息，如果存在多个中间节点，会在`Via`中形成链条`Via:proxy1,proxy2,proxy3`。`Via`中追加的是代理主机名或域名，而且只是用于判断是否存在代理。
- `X-Real-IP`：记录客户端真实IP。
- `X-Forwarded-For`：追加请求方的IP，因此最左边为客户端真实IP。

代理的转发是在后台不可见，因此在客户端不能看到代理做了哪些操作。

### 代理协议

代理服务器操作`X-Forwarded-For`字段时，需要解析HTTP报文头，开销比较大，降低了代理的转发性能；并且修改报文头信息，必须要修改原始报文，在使用`HTTPS`通信加密时，是不能修改的。因此出现了专门的代理协议HAProxy，V1版本只在HTTP报文前添加一行ASCII文本，`PROXY TCP4|TCP6 请求方IP 应答方IP 请求方端口 应答方端口`

