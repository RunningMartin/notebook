# HTTP/2

## 特性概览

HTTP主要有两个缺点：

- 安全性问题：通过SSL/TLS解决。
- 性能问题：只能优化握手加密环境。

HTTP/2将HTTP分解为语义和语法部分，语义和HTTP完全相同，因此基于HTTP的上次应用也不需要修改。HTTP/2没有引入新的协议名，仍然用http表示明文协议，https表示加密协议，因此具体使用哪个协议，有客户端或服务器端决定。

HTTP/2的核心是通过对语法部分进行修改，提升性能。首先，HTTP/2采用HPACK算法对报文头部进行了压缩(客户端和服务器端建立字典，用索引表示重复字符串，对数字和字符串采用哈夫曼编码压缩)。

其次，HTTP/2的报文采用二进制形式，体积小，处理速度快，将原本的HEADER+Body打散为多个二进制帧：HEADERS帧存放头数据，DATA帧存放实体数据，因此对于大文件只有一个HEADERS帧+多个DATA帧(碎片化)。

HTTP/2还利用可以在一个TCP连接上用流同时发送多个碎片化信息的功能，定义了一个流(二进制帧双向传输序列)，实现多路复用。多个请求、响应之间没有了顺序关系，不需要排队等待，不会出现队头阻塞问题，降低了延迟，大幅度提高了连接的利用率。HTTP还在一定程度上改变了请求-应答模式，服务器能建立流主动往客户端发送消息。

HTTP/2的协议栈在TLS层上加了HPack和Stream层。

## 内核剖析

TLS握手成功后，客户端必须发送链接前言(`PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n`，共24字节)用于建立HTTP/2连接。

建立连接后，HTTP/2开始准备请求报文，仍然采用Header+Body的结构，只是Header需要HPACK算法压缩。HPACK算法需要客户端和服务器端各自维护一张索引表，压缩和解压缩是查表和更新表的操作。

HTTP/2中没有起始行概念，整个报文头都采用`Key-Value`结构，原起始行也变为了头字段(不包含版本号和错误短语)，并将这部分称作为伪头字段。伪头字段的名字以`:`开始，如：域名`:authority`、请求方法`:method`、状态码`:status`。HTTP/2中根据一些常用的字段定义了一个只读静态表并维护一个动态表，通过查表则可知字段和对应的值。随着交互的报文越多，两端的字典将越丰富，头部字段将变得越来越小（只发送索引）。

报文被HTTP/2拆分为二进制的帧发送，一个帧有一个9字节的报头。

![帧结构]()

帧长度为3个字节，默认上限为`2^14=16k`，最大上限为`2^24=16M`。

帧类型为1个字节，共两大类：数据帧(DATA、HEADERS)和控制帧(SETTINGS、PING、PRIORITY等管理流的控制帧)。

标志位为1个字节，常用标志位：END_HEADERS（\r\n）头数据结束、END_STREAM(0\r\n\r\n)单向数据发送结束。

流标识符为4个字节(31位)，用于实现流。HTTP/2的帧是乱序发送的，只要具备相同的流ID就属于同一个流，在流中帧是有先后顺序的。但是其具备如下特点：

- 可以建立多个流复用同一个TCP连接。
- 客户端和服务器端也可以建立流。
- 流是双向的，可用于发送或接受帧。
- 帧与帧之间没有关联，帧内部有序。
- 可以设置优先级。
- 流ID只能顺序递增，不能复用，客户端发起为奇数，服务器发起为偶数。
- RST_STREAM帧可以终止帧，取消发送或接受。
- 0号流发送控制帧，用于流量控制。

因此不需要使用Connection字段，会复用同一个连接，如果ID用完，则会发送控制帧GOAWAY，关闭TCP连接。

![流状态转换简图]()

## HTTP/3

HTTP/2采用帧和流技术在应用层解决了队头阻塞问题，但是在TCP中也会出现队头阻塞。

TCP协议通过丢包重传来保证可靠传输，丢失的包必须等待重新传输确认，即使其他部分包都收到了，也只能放在缓冲区中，直到确认后，才会传递给应用。

HTTP/2为了解决队头阻塞问题，采用基于UDP协议的QUIC协议。

QUIC协议基于UDP协议，不需要握手和挥手，因此速度十分快，通过在应用层解决连接管理、流量控制、可靠传输等问题。QUIC协议还引入了HTTP/2中流的概念，单个流内是有序的，可能会因为丢包而阻塞，但其他流不会被影响。QUIC采用全面加密通信，避免其他中间篡改和协议僵化，并且将内含了TLS，使用自己帧接管了TLS的记录，握手消息、警报消息直接采用QUIC的帧发送，节省一次开销。

QUIC的基本数据传输单位为包和帧，一个包由多个帧组成，包面向连接，帧面向流，一个包可以传输多个帧。QUIC使用不透明的连接ID来标记通信的两个端点，客户端和服务器采用ID来标记自己，解除TCP中的四元组的限制，支持连接迁移。

![QUIC包结构]()

通过连接ID，QUIC解决了IP切换时，需要重新建立连接的问题，可以在新IP上直接重用之前的连接，消除重连成本。

QUIC自身支持加密、流和多路复用，因此HTTP/3将被简化，只需调用QUIC的接口来使用流发送请求-响应即可。通过双向流可以实现HTTP/2中的流，单向流能实现控制与推送。HTTP/3将没有默认端口号，通过HTTP/2中的Alt-Svc帧来提供一个`host:port`告知自己的HTTP/3服务，客户端收到后，使用QUIC异步连接端口，连接成功，则切换为HTTP/3。

## HTTP/2优缺点

### 优点

- 完全保持和HTTP/1的兼容。
- 强化了安全。
- 通过头部压缩、多路复用提高带宽利用率，降低延迟。
- 提供服务器推送。

### 缺点

- 只在应用层解决队头阻塞问题，没有彻底解决。
- IP切换时，底层TCP会重连，之前积累的字典将消失，需要重新计算，带宽浪费和时延大。
- 对一个网站只开一个连接，如果连接出问题，则体验差，http/1可以采用开多个连接。

浏览器是如何知道服务器支持HTTP/2。TLS扩展中有一个ALPN，用于服务器对TLS上的应用协议进行协商。Client Hello中会带上ALPN，里面按优先级排列支持的应用协议，Server Hello通过ALPN回复选择。

为什么精灵图、资源内联、域名分片对HTTP/2的性能优化造成反效果？

精灵图：将大量图片合并到一张大图中传输，避免一张一张的显示，减少请求次数。

资源内联：将资源通过base64内嵌到html中。

域名分片：通过将多个域名指向同一个主机，突破浏览器对单个域名并发连接数。

HTTP/2使用小颗粒化的资源，优化缓存。使用精灵图等于传输大文件，大文件会延迟客户端的处理，并且缓存失效的开销很昂贵，即使少量数据更新都会使整个精灵图失效，需要重新下载。

HTTP/1中内联资源也是为了减少请求次数，内联资源无法单独缓存，破坏了HTTP/2的多路复用和优先级策略。

域名分片会增加HTTP/2的连接成本、HPack字典、慢启动等。

