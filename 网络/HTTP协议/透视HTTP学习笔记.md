# 透视HTTP学习笔记

## HTTP是什么？

HTTP中文名为超文本传输协议，其可以拆分为3部分：

![HTTP协议的组成]()

- 协议：HTTP是一个计算机中的协议，它是以计算机语言确定了一种计算机之间相互交流的规范，以及相关的控制与错误处理方式。
- 传输：HTTP是一种计算机世界里专门用于两点之间传输数据的约定和约束。
- 超文本：HTTP传输的数据是文字、图片、视频等的混合体，里面包含超链接，可以从一个超文本跳转到另一个超文本。

总结：HTTP协议是一个在计算机中用于两点之间传输超文本数据的约定和规范。

HTTP协议通常跑在TCP/IP协议栈上，依靠IP协议实现寻址和路由、TCP协议实现可靠传输、DNS协议实现域名查找、SSL/TLS协议实现安全通信。

依赖于HTTP的协议有：WebSocket、HTTPDNS协议。

## 与HTTP相关的概念

- **CDN**：内容分发网络(Content Deliver Network)，采用HTTP协议中的缓存和代理技术，代替服务器响应客户端请求，可以提供负载均衡，缩短响应时间等功能。CDN不会去区分爬虫和正常客户端。
- **Web Service**：网络服务，是一个基于Web的服务架构技术。
- **Web Server**：网络服务器，网络服务的载体。
- **IP协议**：IP协议用于解决定位和路由问题。
- **TCP协议**：基于IP协议，提供可靠的、字节流形式(两端可以向操控文件一样访问传输的数据)的通信。
- **DNS**：提供域名与IP的转换服务，分根DNS、顶级DNS、权威DNS和本地DNS，逐层递归实现域名查询。
- **URI|URL**：URI(Uniform Resource Identifier)统一资源标识符，通过它可以唯一标记互联网上的资源，其核心是标识资源；URL(Uniform Resource Locator)统一资源定位符，通过它能知道去哪里获取该资源，URL是URI的一个子集。
- **HTTPS**：采用SSL/TLS加密HTTP的通信。
- **代理**：作为连接的中转站，可以转发请求或响应。
  - 匿名代理：代理修改信息，外界只知道代理的存在。
  - 透明代理：外界既可以看到代理，也可看到客户端。
  - 正向代理：代表客户端发送请求。
  - 反向代理：代表服务器端响应请求。
  - 可以在代理处实现缓存加速、负载均衡、安全防护、数据处理(数据压缩、加密)等服务。

## 协议分层

TCP/IP协议栈将网络通信划分出多个层次，每个层次只负责该层事务，采用分而治之的思想解决了网络通信问题。

TCP/IP协议栈总共分为4层，从下往上分别是：数据链路层(MAC)、网络层(IP)，传输层(TCP、UDP)、应用层(HTTP)。OSI模型中则分为：物理层、数据链路层、网络层、传输层、会话层、表示层、应用层，通常将会话层、表示层和应用层整合为一层：应用层。因此一般网络通信只分为5层：物理层、数据链路层、网络层、传输层、应用层。

四层负载均衡：作用于传输层，实现对后端服务器的负载均衡，由操作系统负责。

七层负载均衡：作用于应用层，解析HTTP报文后，然后根据适当的策略转发给后端服务器，由具体应用负责。

## 域名

域名是IP的别名，通过域名能更好地记忆网站。通过DNS服务器能将域名转换为IP地址。DNS服务器分为三种：

- 根域名服务器：负责管理顶级域名服务器，返回`com`、`net`等顶级域名服务器的IP地址。
- 顶级域名服务器：负责管理权威域名服务器，如`com`顶级域名服务器可以返回`app.com`权威域名服务器的IP。
- 权威域名服务器：负责管理自己域名下主机IP地址，`app.com`权威域名服务器可以返回`www.app.com`的IP地址。
- 非核心dns服务器：负责DNS缓存，缓存部分域名和IP之间的映射关系，加速解析，如`8.8.8.8`。
- 本地host缓存
- 范围顺序：本地host缓存-->非核心域名服务器-->根域名-->顶级域名-->权威域名服务器。

### 域名玩法

- 重定向
  - 通过修改DNS服务器，可以将域名映射到新的IP，可以保证维护时，业务不中断。
  - 域名指向类似`bind9`搭建内部DNS，作为名字服务器，将域名作为一个名字空间，因此内部服务也可以通过用域名来标识。
  - 通过域名实现负载均衡
    - 域名解析后返回多个IP地址，客户端通过轮询依次向服务器发送请求。
    - 域名解析配置内部策略，返回最近、质量最好的主机。
  - 域名屏蔽：不解析域名
  - 域名污染：将域名解析到错误的网站。

## HTTP实验环境

### 软件

- `Wireshark`：抓包工具
- `Chrome`：浏览器，通过开发者工具观察HTTP传输过程。
- `Telnet`：通过tcp协议登录主机，手动发生HTTP请求，避免干扰。
- `OpenResty`：方便采用Lua实现Web服务器。

## HTTP访问流程

- 解析域名：通过客户端缓存、系统缓存或DNS服务将域名解析IP地址。
- 建立TCP连接
- 客户端发送请求
- 服务器端响应请求
- 客户端解析响应
- 关闭TCP连接

通常域名解析出来的IP指向CDN，CDN缓存了大多数静态资源，当遇到资源不存在或动态资源请求时，请求将被发送到真实的服务器IP。服务器的入口通常为负载均衡设备，负载均衡将先访问系统内的缓存服务器，如果缓存服务器没有，才会去访问应用服务器，应用服务器将结果发送给复杂均衡设备，然后原路返回。

## HTTP报文结构

HTTP协议的报文是纯文本格式

![HTTP报文结构]()

header(起始行、头部字段)与body(消息正文)

### 请求报文

- 请求行
  - 方法名：`GET`、`POST`等。
  - URL
  - HTTP版本
- 请求头部
  - Host是必须的字段。

### 响应报文

- 响应行
  - HTTP版本
  - 状态码
  - 状态码解释
- 响应头部

## 常见请求方法

- 方法的意义：HTTP的请求方法是对资源下发的指令，用于操作资源。
- `GET`：GET用于获取资源。
- `HEAD`：获取资源的信息。
- `POST`：创建资源。
- `PUT`：更新资源。
- `DELETE`：删除资源。
- 安全：请求方法不会破坏服务器上的资源，`GET`和`HEAD`。
- 幂等：多次执行相同操作，结果相同。`GET`、`HEAD`、`DELETE`、`PUT`是幂等操作，`POST`不是幂等操作。

## URI

URI(Uniform Resource Identifier)统一资源标识符用于区分资源。

![URI格式]()

URI下有两个分支：URN和URL，HTTP的世界中采用是URL(Uniform Resource Location)。URL通过资源的位置+资源名称来区分资源，其格式为：

![URL格式]()

默认路径：`/`，表示主目录。

查询参数中`?`代表开始，采用kv结构，如果有多个查询参数用&并列。

URI的编码，避免在参数中出现`?&@`符号，会想ASCII码转移为16进制，然后添加`%`。

## 状态码

状态行由三部分组成：`HTTP版本`、`状态码`、`状态码描述`。

![状态行]()

HTTP协议中的状态码用于表达HTTP数据处理状态。状态码被分为5类：

- `1xx`：提示信息，用于协议处理的中间状态。
  - `101 Switching Protocols`：同意更换传输协议，通常客户端使用`Upgrade`字段告知新的传输协议。
- `2xx`：成功，报文已收到并被正确处理。
  - `200 OK`：正常处理请求。
  - `204 No Content`：正常处理请求，但是只有响应头。
  - `206 Partial Content`：响应了范围请求，通常会在`Content-Range:bytes 0-99/2000`中标识响应的数据范围。
- `3xx`：重定向，资源位置发生变动。
  - `301 Moved Permanently`：永久重定向。
  - `302 Moved Temporarily`：临时重定向，用于临时维护。
  - `304 Not Modified`：资源未修改，用于响应缓存控制。
- `4xx`：客户端错误，请求报文有错误。
  - `400 Bad Request`：通用错误码，用于表示请求报文有问题，比较笼统，不建议使用。
  - `403 Forbiddeb`：禁止访问该资源。
  - `404 Not Found`：资源不存在。
  - `405 Method Not Allowed`：方法不被允许
- `5xx`：服务端错误，处理请求时发生错误。
  - `500 Internal Server Error`：通用错误码。
  - `501 Not Implemented`：功能未实现。
  - `502 Bad Gateway`：服务器作为网关或代理时，访问后端服务器失败。
  - `503 Service Unavailable`：当前服务忙，搭配`Retry-After`字段指示客户端多久后重试。
  
  
  ## HTTP的特点

- 灵活可扩展：只需遵循报文基本结构(header+body)，header和body可自定义。
- 传输可靠：采用TCP协议，提供可靠传输。
- 应用层协议：因为其灵活可扩展，可以传输一切东西，满足各种需求。
- 请求-应答模式：客户端主动请求，服务器端被动响应。
- 无状态：每次请求是独立的。

## HTTP实体

### 实体类型

HTTP协议采用MIME(Multipurpose Internet Mail Extensions)协议来表达实体的类型。实体的类型有`Content-Type`指定。

- text：文本格式数据，常见`text/html`、`text/css`、`text/plain`等。
- image：图像文件，常见`image/jpeg`、`image、gif`、`image/png`等。
- `audio`：音频数据
- `video`：视频数据
- `application`：需要由上层应用解释的数据，如`application/pdf`。

### 实体压缩

HTTP为了节约带宽，可能会压缩数据，压缩格式由`Content-Encoding`指定：

- `gzip`：采用`gzip`压缩。
- `deflate`：采用`deflate`压缩。
- `br`：采用`Brotli`算法压缩(为HTTP优化)。

### 协商

- 客户端通过`Accept`和`Accept-Encoding`传递自己能接受的实体类型和实体压缩方式。服务器端通过`Content-Type`和`Content-Encoding`传递协商结果。
- 语言协商：`Accept-Language`，服务器是`Content-Language`
- 字符集：`Accept-Charset`，响应没有`Content-Charset`
- `Vary`：响应中存储内容协商时参考字段，如：`Vary:Accept-Encoding，User-Agent,Accept`，服务器依据Accept-Encoding，User-Agent,Accept来决定发回的响应报文。因此请求头的相应字段变化，Vary也会随响应报文变化。
