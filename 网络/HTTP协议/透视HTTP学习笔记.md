# 透视HTTP学习笔记

## HTTP是什么？

HTTP中文名为超文本传输协议，其可以拆分为3部分：

![HTTP协议的组成]()

- 协议：HTTP是一个计算机中的协议，它是以计算机语言确定了一种计算机之间相互交流的规范，以及相关的控制与错误处理方式。
- 传输：HTTP是一种计算机世界里专门用于两点之间传输数据的约定和约束。
- 超文本：HTTP传输的数据是文字、图片、视频等的混合体，里面包含超链接，可以从一个超文本跳转到另一个超文本。

总结：HTTP协议是一个在计算机中用于两点之间传输超文本数据的约定和规范。

HTTP协议通常跑在TCP/IP协议栈上，依靠IP协议实现寻址和路由、TCP协议实现可靠传输、DNS协议实现域名查找、SSL/TLS协议实现安全通信。

依赖于HTTP的协议有：WebSocket、HTTPDNS协议。

## 与HTTP相关的概念

- **CDN**：内容分发网络(Content Deliver Network)，采用HTTP协议中的缓存和代理技术，代替服务器响应客户端请求，可以提供负载均衡，缩短响应时间等功能。CDN不会去区分爬虫和正常客户端。
- **Web Service**：网络服务，是一个基于Web的服务架构技术。
- **Web Server**：网络服务器，网络服务的载体。
- **IP协议**：IP协议用于解决定位和路由问题。
- **TCP协议**：基于IP协议，提供可靠的、字节流形式(两端可以向操控文件一样访问传输的数据)的通信。
- **DNS**：提供域名与IP的转换服务，分根DNS、顶级DNS、权威DNS和本地DNS，逐层递归实现域名查询。
- **URI|URL**：URI(Uniform Resource Identifier)统一资源标识符，通过它可以唯一标记互联网上的资源，其核心是标识资源；URL(Uniform Resource Locator)统一资源定位符，通过它能知道去哪里获取该资源，URL是URI的一个子集。
- **HTTPS**：采用SSL/TLS加密HTTP的通信。
- **代理**：作为连接的中转站，可以转发请求或响应。
  - 匿名代理：代理修改信息，外界只知道代理的存在。
  - 透明代理：外界既可以看到代理，也可看到客户端。
  - 正向代理：代表客户端发送请求。
  - 反向代理：代表服务器端响应请求。
  - 可以在代理处实现缓存加速、负载均衡、安全防护、数据处理(数据压缩、加密)等服务。

## 协议分层

TCP/IP协议栈将网络通信划分出多个层次，每个层次只负责该层事务，采用分而治之的思想解决了网络通信问题。

TCP/IP协议栈总共分为4层，从下往上分别是：数据链路层(MAC)、网络层(IP)，传输层(TCP、UDP)、应用层(HTTP)。OSI模型中则分为：物理层、数据链路层、网络层、传输层、会话层、表示层、应用层，通常将会话层、表示层和应用层整合为一层：应用层。因此一般网络通信只分为5层：物理层、数据链路层、网络层、传输层、应用层。

四层负载均衡：作用于传输层，实现对后端服务器的负载均衡，由操作系统负责。

七层负载均衡：作用于应用层，解析HTTP报文后，然后根据适当的策略转发给后端服务器，由具体应用负责。

## 域名

域名是IP的别名，通过域名能更好地记忆网站。通过DNS服务器能将域名转换为IP地址。DNS服务器分为三种：

- 根域名服务器：负责管理顶级域名服务器，返回`com`、`net`等顶级域名服务器的IP地址。
- 顶级域名服务器：负责管理权威域名服务器，如`com`顶级域名服务器可以返回`app.com`权威域名服务器的IP。
- 权威域名服务器：负责管理自己域名下主机IP地址，`app.com`权威域名服务器可以返回`www.app.com`的IP地址。
- 非核心dns服务器：负责DNS缓存，缓存部分域名和IP之间的映射关系，加速解析，如`8.8.8.8`。
- 本地host缓存
- 范围顺序：本地host缓存-->非核心域名服务器-->根域名-->顶级域名-->权威域名服务器。

### 域名玩法

- 重定向
  - 通过修改DNS服务器，可以将域名映射到新的IP，可以保证维护时，业务不中断。
  - 域名指向类似`bind9`搭建内部DNS，作为名字服务器，将域名作为一个名字空间，因此内部服务也可以通过用域名来标识。
  - 通过域名实现负载均衡
    - 域名解析后返回多个IP地址，客户端通过轮询依次向服务器发送请求。
    - 域名解析配置内部策略，返回最近、质量最好的主机。
  - 域名屏蔽：不解析域名
  - 域名污染：将域名解析到错误的网站。

## HTTP实验环境

### 软件

- `Wireshark`：抓包工具
- `Chrome`：浏览器，通过开发者工具观察HTTP传输过程。
- `Telnet`：通过tcp协议登录主机，手动发生HTTP请求，避免干扰。
- `OpenResty`：方便采用Lua实现Web服务器。

## HTTP访问流程

- 解析域名：通过客户端缓存、系统缓存或DNS服务将域名解析IP地址。
- 建立TCP连接
- 客户端发送请求
- 服务器端响应请求
- 客户端解析响应
- 关闭TCP连接

通常域名解析出来的IP指向CDN，CDN缓存了大多数静态资源，当遇到资源不存在或动态资源请求时，请求将被发送到真实的服务器IP。服务器的入口通常为负载均衡设备，负载均衡将先访问系统内的缓存服务器，如果缓存服务器没有，才会去访问应用服务器，应用服务器将结果发送给复杂均衡设备，然后原路返回。

## HTTP报文结构

HTTP协议的报文是纯文本格式

![HTTP报文结构]()

header(起始行、头部字段)与body(消息正文)

### 请求报文

- 请求行
  - 方法名：`GET`、`POST`等。
  - URL
  - HTTP版本
- 请求头部
  - Host是必须的字段。

### 响应报文

- 响应行
  - HTTP版本
  - 状态码
  - 状态码解释
- 响应头部
