# HTTP协议学习笔记—HTTP2

## 0X01 概述

HTTP/1有两个主要的缺点：

- 安全方面
- 性能方面

HTTPS协议通过引入`SSL/TLS`协议解决了安全方面的问题。但性能方面只优化了握手流程，传输过程中没有优化。HTTP/2针对性能方面进行改进，其协议栈是：

![HTTP/2协议栈]()

HTTP/2改进的核心是：

- 兼容：采用和HTTP/1相同的语义，如请求方法、协议名等。
- 压缩头部：采用HPACK算法，在客户端和服务器建立字典，用索引表示重复字符串，并采用哈夫曼编码压缩索引。
- 二进制帧传输：将报文碎片化为二进制帧，采用帧来传输数据。
- 流：流是二进制帧的双向传输序列，同一个连接的帧有流ID和序号ID，对端接收后根据序号组装成报文。同一连接上可以有多个流(多路复用)，因此可以采用不同的流发送不同的请求/响应，不会出现队头阻塞问题。HTTP/2还提供多种控制帧来管理流，实现优先级和流量控制。
  ![HTTP2 多路复用]()

- 服务器推送：可以主动向客户端推送数据。

HTTP/2和HTTP/1使用相同的协议名：https和http。主流的浏览器只支持加密版本的HTTP/2，HTTP/2明文版本只用于非浏览器的情况。为了区别明文和加密，HTTP/2定义了两个标识符：`h2`(加密)、`h2c`(明文)。

## 0X02 连接

客户端与服务器完成握手后，向服务器发送Magic(`PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n`)。服务器识别到该字符串后，后续数据将采用HTTP/2。

## 0X03 头部压缩

HTTP/2采用HPACK来压缩报文头部，其核心是在客户端和服务器上各自维护一个头部信息表(键值对)。这个表是和连接相关联的，如果连接断开，将重新维护。

![HTTP/2静态表]()

客户端发送请求时，将执行压缩操作：如果键值对已经存在，则转换为相应序号；如果不存在，则在表中添加记录，进入准备状态。压缩后，头部将由已存键值对的序号和未存键值对原文。HTTP/2还采用哈夫曼编码对序号进一步压缩。

服务器收到请求后，执行解压缩操作：针对序号，查表获取原文；针对原文，更新表。生成响应，向客户端发送响应。客户端收到响应后，更新表中装备状态的键值对。

![HTTP/2更新表流程]()

为了方便管理和压缩，HTTP/2使用伪头部字段替换了HTTP/1协议中的起始行，将整个头部都被整合为Key-Value结构。伪头部字段以`:`开头，如`:authority`(域名)、`:method`(方法)、`:status`(状态码)。

头部信息表又分为静态表和动态表：

- 静态表存储常用的头部信息

![HTTP/2静态表]()

- 动态表存储两端动态变化的头部信息

随着报文数量的增加，头部信息表将越来越丰富，报文的头部也将越来越小，直到全部采用序号表示。

## 0X04 二进制帧

HTTP/2的帧结构简单，其头部只有9个字节。

![HTTP/2帧结构]()

- 帧长度为3个字节，描述数据部分长度，默认上限为`2^14=16k`，最大上限为`2^24=16M`。
- 帧类型为1个字节，共两大类：数据帧(DATA、HEADERS)和控制帧(SETTINGS、PING、PRIORITY等管理流的控制帧)。
- 标志位为1个字节，常用标志位：END_HEADERS（\r\n）头数据结束、END_STREAM(0\r\n\r\n)单向数据发送结束。
- 流标识符为4个字节(31位)，用于实现流。HTTP/2的帧是乱序发送，具备相同流ID的帧具备先后顺序。
