# SQL查询语句执行流程

## 0X00 MySQL的基础架构

![基础架构示意图]()

大体上MySQL可以分为两层：

- Server层
- 存储引擎层

Server层中有连接器、查询缓存、分析器、优化器、执行器等，涵盖MySQL大部分核心功能以及所有内置函数和跨存储引擎的功能。

存储引擎层负责数据的存储和提取，存储引擎以插件形式存在，默认InnoDB。

## 0X01 连接器

连接器负责和客户端建立连接、获取权限、维持和管理连接。`mysql -h ip -P password -u root -p`。连接器会先去验证账号和密码并从权限表中读取权限，后续操作中的权限判断依赖于此时获取的权限，因此成功建立连接后，管理员修改权限只能影响新的连接。通过命令`show processlist;`可以查看已有连接也可以通过dbmonitor工具查看访问信息。

如果客户端长时间未活动，连接器将自动断开连接`wait_timeout=8小时`。连接分为长连接和短连接，建立长连接后，如果客户端有持续请求，将一直使用同一个连接；短连接则意味着每次执行几个查询，则断开连接，连接需要消耗一定的时间，因此尽量使用长连接。

MySQL在执行过程中使用的内存是管理在连接对象中，连接断开时才会释放，因此大量长连接会消耗大量内存。解决方案：

- 定期断开长连接。
- Mysql 5.7以上版本，执行完较大操作后，执行`mysql_reset_connection`重新初始化连接资源(不会重连和权限验证)。

## 0X02 查询缓存

MySQL拿到查询请求后会先查询缓存。之前执行过的语句会和结果以Key-Value的形式存在，被缓存在内存中。如果缓存命中，则直接返回结果，缓存未命中，执行后续操作。

查询缓存的失效非常频繁，只要对一个表进行更新，该表的所有查询缓存都将被清空。对于频繁更新的表，其查询缓存命中率会十分低下，只有静态表才适合查询缓存。可以通过将参数`query_cache_type`设置为DEMAND，需要使用查询缓存可以通过`SELECT SQL_CACHE * from 表`显示指定。MySQL 8.0已经删除查询缓存。

## 0X03 分析器

分析要先进行词法分析、语法分析，判断SQL语句是否满足MySQL的要求。

## 0X04 优化器

优化器决定该SQL语句的执行方案。

## 0X05 执行器

首先判断执行权限(触发器在执行过程才能出发，因此只能在执行器中确定权限 )，权限通过后，根据执行方案调用引擎相关接口。可以通过慢日志中的`rows_examined`字段判断语句执行过程中调用了引擎获取数据行的次数(引擎扫描行数可能多余接口调用次数)

## 0X06 MySQL debug模式

`mysqld --debug --console &`
