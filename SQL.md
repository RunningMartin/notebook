# SQL

SQL语言是声明性的语言，只需通过SQL描述想要的数据，数据库管理系统会为我们提供相应的数据。ER图为实体-关系图，具备三要素：实体、属性、关系。

SQL保留字、函数名、绑定变量名大写，自己定义的小写

SQL语言按功能可以分为：

- DDL(Data Definition Language)：数据定义语言，用于定义数据库对象，如数据库、表、列。
- DML(Data Manipulation Language)：数据操作语言，用于操作与数据库相关的记录，如增加、删除、修改表中的记录。
- DCL(Data Control Language)：数据控制语言，用于定义访问权限和安全级别。
- DQL(Data Query Language)：数据查询语言，定于查询数据。

## 常用数据库

- 关系型数据库：建立在关系模型基础上的数据库。
  - MySQL
  - MariaDB：大部分与MySQL兼容。
- 键值型数据库：通过Key-Value键值的方式存储数据，查找速度快，但是不能自由的条件过滤，常用于内容缓存。
  - Redis
- 文档型数据库：以文档为单位存储信息，一个文档为一条记录。
  - MongoDB
- 搜素引擎：用于全文搜素，Elasticsearch，核心原理倒排索引。
- 图像数据库：用于存图结构。

## SQL执行原理

- Oracle：SQL语句会经过如下流程

  - 语法检查：语句拼写是否正确。
  - 语义检查：访问的对象是否存在，如表名，列名。
  - 权限检查：检查是否有访问该数据库的权限。
  - 共享池检查：获取SQL语句hash值，通过hash值检查库缓存(Library Cache)中查找，如果存在，则直接使用其缓存的执行计划，然后交由执行器(软解析)；不存在，则进入优化器。
  - 优化器：优化器根据SQL语句创建解析树、生成执行计划（硬解析）。
  - 执行器：根据解析树与执行计划执行SQL语句。
  - 共享池为Oracle的专属名称，包含库缓存、数据字典缓存区等
    - 库缓存决定SQL语句是否需要硬解析，应该避免硬解析(消耗资源)，为了避免硬解析，可以使用绑定变量，即在SQL语句中使用变量，提高软解析可能性，但是可能会导致生成的执行计划不够优化(每个表中使用绑定列表的列数据分布不均)。
    - 数据字典缓存区存储对象的定义，如表、视图、索引的等对象，在解析SQL语句时，可以直接从中获取目标对象的相关信息。

- MySQL：MySQL是经典的CS架构。

  - MySQL的服务端由`mysqld`提供，主要分为3层
    - 连接层：负责服务器端与客户端建立连接。
    - SQL层：对SQL语句进行查询处理。
    - 存储引擎层：与数据库文件交互，负责数据的存储和读取。
  - SQL层：
    - 缓存查询：Server查询缓存，如果存在这条语句则立即返回结果，MySQL8.0后取消该功能，当数据表被更新，则会清空所有缓存，因此只有当表为静态表，使用缓存查询才有意义。
    - 解析器：对SQL语句进行语法、语义分析。
    - 优化器：确定SQL的执行路径，如全表检索、索引检索。
    - 执行器：判断权限，执行SQL并返回结果(MySQL8.0以下会对查询结果进行缓存)。
  - 存储引擎层：MySQL中存储引擎是以插件的形式存在的，不同的引擎有不同的特点。
    - InnoDB：MySQL5.5.8以后默认存储引擎，支持事务、行级锁定、外键约束。
    - MyISAM：MySQL5.5.8之前的默认存储引擎，不支持事务与外键，优点是速度快、占用资源小。
    - Memory：采用内存作为存储介质，相应速度快，但当Server进程崩溃时，将丢失数据。适用于临时数据。
    - Archive：良好的压缩机制，适合文件归档。
  - 分析方法

  ```sql
  '查询分析是否打开'
  select @@profiling;
  '打开分析'
  set profiling=1;
  '执行查询语句'
  '查看产生的profiles'
  show profiles;
  '查看最近的'
  show profile;
  '根据id查看'
  show profile for query {id};
  ```
